---
title: "Data entry, cleaning, and working datasets generation"
output: html_notebook
editor_options: 
  chunk_output_type: inline
README: Section order is relevant, prompt errors may be caused by failing to run previous code sections
---

The script will do the following:
1) add the most recent it to the aggregated 5min dataset (following istructions in 'readme' file about file names)
2) download discharge data from USGS for the site and date period
3) generate a 15min averaged dataset with chl, temp, and Q data
4) generate a BASEFLOW 15min averaged dataset with chl, temp, and Q data
5) generate a STORMFLOW 15min averaged dataset with chl, temp, and Q data

###########################################################
Modifiy the following information before running the script
```{r}
directory = "C:/Users/admin/Dropbox/cyclops"
aggregfile = "BRA_BAM.csv"
lastfile = "BRA_BAM_Jul22-Jul252019.csv"
startQdate = "2019-03-28"
endQdate = "2019-08-23"
siteQcode = "01481000" #01481000 for BAM and 01481500 for WILMA

```

```{r}
setwd("C:/Users/admin/iCloudDrive/cyclops/")
```


########################################################
Run the script; knit so partial results can be assessed  
########################################################
```{r,warning=T}
#necessary packages: 
pack_list<-list ("xts","dataRetrieval","dplyr","dataRetrieval","devtools","DataCombine","lubridate","zoo")
for(i in 1:length(pack_list)){
  p <- pack_list[[i]]
  install.packages(p,repos = "https://cran.rstudio.com",dependencies = TRUE)
}


#####SESTON Data input from .csv and RESEARCH server. File is named by sensor's name only. File include date, 
#####time, battery, temperature, chl(ug/L), gain voltage (change chl column from scientific format to general)


library(dplyr)
setwd(directory)
chldata = read.csv(aggregfile) ; chldata[,1] <- NULL ; chldata = select (chldata,-c(datetime)) ; tail(chldata,1)
chldata2 = read.csv(lastfile) ; head(chldata2,1)
chldata = rbind(chldata,chldata2)
chldata$datetime<- as.vector(as.POSIXct(paste(chldata$date, chldata$time), format="%m/%d/%Y %H:%M:%S", tz="EST"))
write.csv(chldata, file = aggregfile) #output #1, aggregated dataset of chl and temperature every 5min


#####DISCHARGE data input via URL from USGS using dataRetrieval package


library(dataRetrieval)#check station code online (usually an 8-15 digit numebr)
###checking parameter code
parameterCdFile <- parameterCdFile
Cds = filter(parameterCdFile, grepl("Discharge", parameterCdFile$parameter_nm,ignore.case=TRUE))

###Input request specifications:
siteNo <- siteQcode
pCode <- "00060"
start.date <- startQdate
end.date <- endQdate 
####retrieve data every 15min
        BAM_q <- readNWISuv(siteNumbers = siteNo, 
                            parameterCd = pCode, 
                            startDate = start.date, 
                            endDate = end.date,tz = "EST") 

####retrieve daily average Q
        BAM_q_daily <- readNWISdv(siteNumbers = siteNo, 
                            parameterCd = pCode, 
                            startDate = start.date, 
                            endDate = end.date) 
qdata15 = BAM_q
qdata = BAM_q_daily
```  
